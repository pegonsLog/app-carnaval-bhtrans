<div class="blocos-list-container">
  <div class="header-section">
    <h2>Blocos Cadastrados</h2>
    <button class="refresh-btn" (click)="carregarBlocos()" [disabled]="isLoading" *ngIf="authService.podeEditar">
      <ng-icon name="heroMagnifyingGlass"></ng-icon>
      {{ isLoading ? 'Carregando...' : 'Atualizar' }}
    </button>
  </div>

  <div class="error-message" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Carregando blocos...</p>
  </div>

  <div class="filters-section" *ngIf="!isLoading && blocos.length > 0">
    <div class="filters-grid">
      <div class="filter-group">
        <label>Nome do Bloco</label>
        <input type="text" [(ngModel)]="filtroNome" (ngModelChange)="aplicarFiltros()" placeholder="Buscar por nome...">
      </div>
      <div class="filter-group">
        <label>Regional</label>
        <select [(ngModel)]="filtroRegional" (ngModelChange)="aplicarFiltros()">
          <option value="">Escolha a regional</option>
          <option *ngFor="let regional of regionaisDisponiveis" [value]="regional">{{ regional }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Data do Desfile</label>
        <select [(ngModel)]="filtroDataDesfile" (ngModelChange)="aplicarFiltros()">
          <option value="">Escolha a data</option>
          <option *ngFor="let data of datasDesfileDisponiveis" [value]="data">{{ data }} - {{ getDiaSemana(data) }}
          </option>
        </select>
      </div>
      <div class="filter-group">
        <label>Busca Livre</label>
        <input type="text" [(ngModel)]="filtroLivre" (ngModelChange)="aplicarFiltros()"
          placeholder="Buscar em todos os campos...">
      </div>
    </div>
    <button class="clear-filters-btn" (click)="limparFiltros()"
      *ngIf="filtroNome || filtroRegional || filtroDataDesfile || filtroLivre">
      Limpar Filtros
    </button>
  </div>

  <div class="table-section" *ngIf="!isLoading && blocos.length > 0">
    <p class="count-info">{{ blocosFiltrados.length }} de {{ blocos.length }} bloco(s)</p>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="action-col"></th>
            <th>#</th>
            <th *ngFor="let col of displayColumns">{{ col.label }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bloco of blocosFiltrados; let i = index">
            <td class="action-col">
              <div class="action-buttons">
                <button class="view-btn" (click)="abrirDocumentoCompleto(bloco)" title="Ver DOT">
                  <ng-icon name="heroEye"></ng-icon>
                </button>
                <button class="map-btn" (click)="abrirMapaExterno(bloco)" title="Ver mapa" *ngIf="bloco.myMapsEmbedUrl">
                  <ng-icon name="heroMapPin"></ng-icon>
                </button>
                <button class="acoes-btn" (click)="abrirAcoes(bloco)" title="Ações" *ngIf="authService.podeEditar">
                  <ng-icon name="heroCog6Tooth"></ng-icon>
                </button>
              </div>
            </td>
            <td class="row-number">
              <span class="row-index">{{ i + 1 }}</span>
              <span class="kml-badge" *ngIf="bloco.percursoUrl" title="KML importado">✓</span>
            </td>
            <td *ngFor="let col of displayColumns" class="cell-content">
              <div class="cell-wrapper">
                <span class="text-truncate" [title]="formatValue(bloco[col.key], col.key)">{{
                  getTruncatedText(formatValue(bloco[col.key], col.key)) }}</span>

                <button *ngIf="isTextLong(formatValue(bloco[col.key], col.key))" class="tooltip-trigger"
                  (click)="showTooltip(i, col.key, bloco[col.key])">
                  <ng-icon name="heroEllipsisHorizontal"></ng-icon>
                </button>

                <div class="tooltip-balloon" *ngIf="isTooltipActive(i, col.key)">
                  <button class="tooltip-close" (click)="hideTooltip()">
                    <ng-icon name="heroXMark"></ng-icon>
                  </button>
                  <p>{{ tooltipContent }}</p>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="empty-state" *ngIf="!isLoading && blocos.length === 0 && !errorMessage">
    <ng-icon name="heroMagnifyingGlass" class="empty-icon"></ng-icon>
    <p>Nenhum bloco cadastrado</p>
    <p class="empty-subtitle">Importe um arquivo Excel para adicionar blocos</p>
  </div>
</div>

<!-- Modal de Detalhe -->
<app-bloco-detalhe *ngIf="blocoSelecionado" [bloco]="blocoSelecionado" (fechar)="fecharDetalhe()">
</app-bloco-detalhe>

<!-- Modal de Upload KML -->
<app-kml-upload *ngIf="blocoParaUploadKml" [bloco]="blocoParaUploadKml" (fechar)="fecharUploadKml()"
  (uploadConcluido)="onKmlUploadConcluido($event)">
</app-kml-upload>

<!-- Modal de Visualização do Percurso -->
<app-percurso-viewer *ngIf="blocoParaVisualizarPercurso" [bloco]="blocoParaVisualizarPercurso"
  (fechar)="fecharVisualizarPercurso()">
</app-percurso-viewer>

<!-- Modal de Confirmação de Remoção -->
<app-confirm-modal *ngIf="blocoParaRemover" titulo="Remover Arquivo"
  [mensagem]="'Deseja remover o arquivo descritivo do bloco ' + blocoParaRemover.nomeDoBloco + '?'" tipo="danger"
  (confirmar)="confirmarRemocao()" (cancelar)="fecharModalRemover()">
</app-confirm-modal>

<!-- Modal de Confirmação de Remoção do Mapa -->
<app-confirm-modal *ngIf="blocoParaRemoverMapa" titulo="Remover Mapa"
  [mensagem]="'Deseja remover o mapa do bloco ' + blocoParaRemoverMapa.nomeDoBloco + '? Isso removerá a URL do mapa e o arquivo descritivo.'"
  tipo="danger" (confirmar)="confirmarRemocaoMapa()" (cancelar)="fecharModalRemoverMapa()">
</app-confirm-modal>

<!-- Modal de Documento Belotur -->
<app-dados-belotur *ngIf="blocoParaDocumento" [bloco]="blocoParaDocumento" (fechar)="fecharDocumentoBelotur()">
</app-dados-belotur>

<!-- Modal de Documento My Maps -->
<app-dados-mymaps *ngIf="blocoParaDocumentoMymaps" [bloco]="blocoParaDocumentoMymaps"
  (fechar)="fecharDocumentoMymaps()">
</app-dados-mymaps>

<!-- Modal de Ações do Bloco -->
<app-bloco-acoes-modal *ngIf="blocoParaAcoes" [bloco]="blocoParaAcoes" (fechar)="fecharAcoes()"
  (documentoBelotur)="onAcaoDocumentoBelotur($event)" (uploadKml)="onAcaoUploadKml($event)"
  (visualizarPercurso)="onAcaoVisualizarPercurso($event)" (documentoMymaps)="onAcaoDocumentoMymaps($event)"
  (documentoCompleto)="onAcaoDocumentoCompleto($event)" (removerArquivo)="onAcaoRemoverArquivo($event)"
  (removerMapa)="onAcaoRemoverMapa($event)" (gerenciarAgentes)="onAcaoGerenciarAgentes($event)"
  (gerenciarDesvios)="onAcaoGerenciarDesvios($event)" (gerenciarFaixasTecido)="onAcaoGerenciarFaixasTecido($event)"
  (gerenciarFechamentos)="onAcaoGerenciarFechamentos($event)"
  (gerenciarReservasArea)="onAcaoGerenciarReservasArea($event)"
  (gerenciarSinalizacoes)="onAcaoGerenciarSinalizacoes($event)">
</app-bloco-acoes-modal>

<!-- Modal CRUD Agentes -->
<app-crud-agentes *ngIf="blocoParaCrudAgentes" [bloco]="blocoParaCrudAgentes" (fechar)="fecharCrudAgentes()"
  (salvar)="salvarAgentes($event)">
</app-crud-agentes>

<!-- Modal CRUD Desvios -->
<app-crud-desvios *ngIf="blocoParaCrudDesvios" [bloco]="blocoParaCrudDesvios" (fechar)="fecharCrudDesvios()"
  (salvar)="salvarDesvios($event)">
</app-crud-desvios>

<!-- Modal CRUD Faixas de Tecido -->
<app-crud-faixa-tecido *ngIf="blocoParaCrudFaixasTecido" [bloco]="blocoParaCrudFaixasTecido"
  (fechar)="fecharCrudFaixasTecido()" (salvar)="salvarFaixasTecido($event)">
</app-crud-faixa-tecido>

<!-- Modal CRUD Fechamentos -->
<app-crud-fechamentos *ngIf="blocoParaCrudFechamentos" [bloco]="blocoParaCrudFechamentos"
  (fechar)="fecharCrudFechamentos()" (salvar)="salvarFechamentos($event)">
</app-crud-fechamentos>

<!-- Modal CRUD Reserva de Área -->
<app-crud-reserva-area *ngIf="blocoParaCrudReservasArea" [bloco]="blocoParaCrudReservasArea"
  (fechar)="fecharCrudReservasArea()" (salvar)="salvarReservasArea($event)">
</app-crud-reserva-area>

<!-- Modal CRUD Sinalização -->
<app-crud-sinalizacao *ngIf="blocoParaCrudSinalizacoes" [bloco]="blocoParaCrudSinalizacoes"
  (fechar)="fecharCrudSinalizacoes()" (salvar)="salvarSinalizacoes($event)">
</app-crud-sinalizacao>

<!-- Modal de Mapa -->
<app-mapa-modal *ngIf="mapaUrl" [url]="mapaUrl" [titulo]="mapaTitulo" (fechar)="fecharMapa()">
</app-mapa-modal>
