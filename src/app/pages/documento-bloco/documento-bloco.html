<div class="documento-container">
  <!-- Header com ações (não imprime) -->
  <div class="header-actions no-print">
    <button class="btn-voltar" (click)="voltar()">
      <ng-icon name="heroArrowLeft"></ng-icon>
      Voltar
    </button>
    <h1>Documento do Bloco</h1>
    <div class="header-buttons">
      <button class="btn-exportar" (click)="exportarDocx()" [disabled]="isLoading">
        <ng-icon name="heroDocumentArrowDown"></ng-icon>
        Exportar DOCX
      </button>
      <button class="btn-imprimir" (click)="imprimir()" [disabled]="isLoading">
        <ng-icon name="heroPrinter"></ng-icon>
        Imprimir
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Carregando documento...</p>
  </div>

  <!-- Erro -->
  <div class="error-state" *ngIf="errorMessage && !isLoading">
    <p>{{ errorMessage }}</p>
    <button class="btn-voltar" (click)="voltar()">Voltar para lista</button>
  </div>

  <!-- Documento -->
  <div class="documento-wrapper" *ngIf="!isLoading && !errorMessage && bloco">

    <!-- PÁGINA 1: CAPA -->
    <div class="a4-page capa-page" *ngIf="capa">
      <div class="capa-header">
        <p class="linha">Empresa de Transportes e Trânsito de Belo Horizonte S/A - BHTRANS</p>
        <p class="linha">Diretoria de Ação Regional e Operação – DRO</p>
        <p class="linha">Superintendência de Ação Regional – SARE</p>
        <p class="linha">{{ capa.gerencia }}</p>
      </div>

      <div class="capa-centro">
        <h2 class="nome-bloco">{{ bloco.nomeDoBloco }}</h2>

        <div class="capa-logo">
          <img src="assets/logomarcas/logomarcas.png" alt="Logo" />
        </div>
      </div>

      <div class="capa-elaboracao">
        <p class="linha" *ngIf="capa.elaboradoPor">Elaboração: {{ capa.elaboradoPor }}</p>
      </div>

      <div class="capa-footer">
        <p class="cidade">BELO HORIZONTE</p>
        <p class="data">{{ capa.dataElaboracao ? formatarDataCapa(capa.dataElaboracao) : '' }}</p>
      </div>
    </div>

    <!-- PÁGINA: DADOS BELOTUR -->
    <div class="a4-page dados-page">
      <div class="doc-header">
        <div class="header-text">
          <h1>DADOS DO BLOCO</h1>
        </div>
      </div>

      <!-- <div class="doc-divider"></div> -->

      <!-- Identificação -->
      <section class="doc-section">
        <h3 class="section-title">IDENTIFICAÇÃO DO BLOCO</h3>
        <div class="info-grid">
          <div class="info-item full">
            <span class="label">Nome do Bloco:</span>
            <span class="value">{{ bloco.nomeDoBloco || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Nº Inscrição:</span>
            <span class="value">{{ bloco.numeroInscricao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Categoria:</span>
            <span class="value">{{ bloco.categoriaDoBloco || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Período:</span>
            <span class="value">{{ bloco.periodo || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Regional:</span>
            <span class="value">{{ bloco.regional || '-' }}</span>
          </div>
        </div>
      </section>

      <!-- Responsável -->
      <section class="doc-section">
        <h3 class="section-title">RESPONSÁVEL LEGAL</h3>
        <div class="info-grid">
          <div class="info-item full">
            <span class="label">Nome:</span>
            <span class="value">{{ bloco.responsavelLegal || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">CPF:</span>
            <span class="value">{{ bloco.cpf || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">CNPJ:</span>
            <span class="value">{{ bloco.cnpj || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">E-mail:</span>
            <span class="value">{{ bloco.email || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Celular:</span>
            <span class="value">{{ bloco.celular || '-' }}</span>
          </div>
        </div>
      </section>



      <!-- Data e Horários -->
      <section class="doc-section">
        <h3 class="section-title">DATA E HORÁRIOS DO DESFILE</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Data do Desfile:</span>
            <span class="value">{{ formatDate(bloco.dataDoDesfile) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Concentração:</span>
            <span class="value">{{ bloco.horarioDeconcentracao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Início:</span>
            <span class="value">{{ bloco.inicioDoDesfile || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Encerramento:</span>
            <span class="value">{{ bloco.horarioEncerramento || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Duração:</span>
            <span class="value">{{ bloco.duracaoDoDesfile || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Dispersão:</span>
            <span class="value">{{ bloco.horarioDispersao || '-' }}</span>
          </div>
        </div>
      </section>

      <!-- Público -->
      <section class="doc-section">
        <h3 class="section-title">PÚBLICO ESTIMADO</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Público Anterior:</span>
            <span class="value">{{ formatNumber(bloco.publicoAnterior) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Público Declarado:</span>
            <span class="value">{{ formatNumber(bloco.publicoDeclarado) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Área do Trajeto:</span>
            <span class="value">{{ formatNumber(bloco.areaDoTrajetoM2) }} m²</span>
          </div>
          <div class="info-item">
            <span class="label">Capacidade:</span>
            <span class="value">{{ formatNumber(bloco.capacidadePublicoDoTrajeto) }} pessoas</span>
          </div>
        </div>
      </section>

      <!-- Percurso -->
      <section class="doc-section">
        <h3 class="section-title">PERCURSO E LOCALIZAÇÃO</h3>
        <div class="info-grid">
          <div class="info-item full">
            <span class="label">Percurso:</span>
            <span class="value">{{ bloco.percurso || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">End. Concentração:</span>
            <span class="value">{{ bloco.enderecoDeConcentracao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Bairro Concentração:</span>
            <span class="value">{{ bloco.bairroDeConcentracao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">End. Dispersão:</span>
            <span class="value">{{ bloco.enderecoDeDispersao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Bairro Dispersão:</span>
            <span class="value">{{ bloco.bairroDeDispersao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Extensão:</span>
            <span class="value">{{ formatNumber(bloco.extensaoDoDesfileMetros) }} m</span>
          </div>
          <div class="info-item">
            <span class="label">Nº de Quadras:</span>
            <span class="value">{{ bloco.numeroDeQuadras || '-' }}</span>
          </div>
        </div>
      </section>

      <!-- Características -->
      <section class="doc-section">
        <h3 class="section-title">CARACTERÍSTICAS</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Perfil:</span>
            <span class="value">{{ bloco.perfil || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Estilo Musical:</span>
            <span class="value">{{ bloco.estiloDeMusica || '-' }}</span>
          </div>
          <div class="info-item full">
            <span class="label">Descrição:</span>
            <span class="value">{{ bloco.descricaoDoBloco || '-' }}</span>
          </div>
        </div>
      </section>


      <!-- Status -->
      <section class="doc-section">
        <h3 class="section-title">STATUS</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Possui Desfiles:</span>
            <span class="value">{{ formatBoolean(bloco.possuiDesfiles) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Status do Desfile:</span>
            <span class="value">{{ bloco.statusDoDesfile || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Autoriza Divulgação:</span>
            <span class="value">{{ formatBoolean(bloco.autorizaDivulgacao) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Primeiro Cadastro:</span>
            <span class="value">{{ formatBoolean(bloco.primeiroCadastro) }}</span>
          </div>
        </div>
      </section>


      <!-- Equipamentos -->
      <section class="doc-section">
        <h3 class="section-title">EQUIPAMENTOS E DIMENSÕES</h3>
        <div class="info-grid">
          <div class="info-item full">
            <span class="label">Equipamentos:</span>
            <span class="value">{{ formatArray(bloco.equipamentosUtilizados) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Largura:</span>
            <span class="value">{{ bloco.larguraMetros || '-' }} m</span>
          </div>
          <div class="info-item">
            <span class="label">Comprimento:</span>
            <span class="value">{{ bloco.comprimentoMetros || '-' }} m</span>
          </div>
          <div class="info-item">
            <span class="label">Altura:</span>
            <span class="value">{{ bloco.alturaMetros || '-' }} m</span>
          </div>
          <div class="info-item">
            <span class="label">Potência:</span>
            <span class="value">{{ formatNumber(bloco.potenciaWatts) }} W</span>
          </div>
        </div>
      </section>

      <div class="doc-footer">
        <p>Data de Cadastro/Modificação: {{ formatDate(bloco.dataCadastroModificacao) }}</p>
      </div>
    </div>

    <!-- PÁGINA: MAPA (iframe do Google Maps) -->
    <div class="a4-page mapa-page" *ngIf="safeMapUrl || parsedMymaps?.mapUrl">
      <div class="doc-header">
        <div class="header-text">
          <h1>MAPA DO BLOCO</h1>
        </div>
      </div>

      <!-- <div class="doc-divider"></div> -->

      <div class="mapa-container" *ngIf="safeMapUrl">
        <iframe [src]="safeMapUrl" width="100%" height="100%" frameborder="0" allowfullscreen>
        </iframe>
      </div>

      <!-- Fallback: link para abrir o mapa -->
      <div class="mapa-fallback" *ngIf="!safeMapUrl && parsedMymaps?.mapUrl">
        <p>O mapa não pode ser exibido diretamente.</p>
        <a [href]="parsedMymaps.mapUrl" target="_blank" rel="noopener" class="btn-abrir-mapa">
          Abrir Mapa no Google Maps
        </a>
      </div>

      <div class="doc-footer">
        <p>Mapa gerado a partir do Google My Maps</p>
        <p class="map-url no-print" *ngIf="mapEmbedUrl">URL: {{ mapEmbedUrl }}</p>
      </div>
    </div>

    <!-- PÁGINA: DADOS OPERACIONAIS (quebra automática) -->
    <div class="a4-page dados-operacionais-page" *ngIf="parsedMymaps?.secoes?.length > 0">
      <div class="doc-header">
        <div class="header-text">
          <h1>DADOS OPERACIONAIS</h1>
          <p class="subtitle">{{ bloco.nomeDoBloco }}</p>
        </div>
      </div>
      <!-- <div class="doc-divider"></div> -->

      <!-- Seções dinâmicas do KML -->
      <ng-container *ngFor="let secao of parsedMymaps.secoes">
        <section class="doc-section operacional-section">
          <h3 class="section-title">{{ secao.titulo | uppercase }}</h3>

          <!-- Lista de Placemarks Agrupados -->
          <div class="placemarks-list" *ngIf="secao.placemarks?.length > 0">
            <div class="placemark-item" *ngFor="let placemark of secao.placemarks; let i = index">
              <div class="placemark-header">
                <span class="placemark-index">{{ i + 1 }}.</span>
                <span class="placemark-name">{{ placemark.name }}</span>
                <span class="placemark-quantidade">{{ placemark.quantidade }}</span>
              </div>
              <div class="placemark-descriptions" *ngIf="placemark.descriptions?.length > 0">
                <div class="description-group" *ngFor="let desc of placemark.descriptions; let j = index">
                  <p *ngFor="let linha of desc" [innerHTML]="formatDescriptionLine(linha)"></p>
                </div>
              </div>
            </div>
          </div>

          <!-- Contagem no final -->
          <div class="secao-contagem" *ngIf="secao.totalItens > 0">
            <div class="contagem-total">
              <strong>Total:</strong> {{ secao.totalItens }} item(ns)
            </div>
          </div>

          <!-- Mensagem se não houver placemarks -->
          <p class="sem-dados" *ngIf="!secao.placemarks || secao.placemarks.length === 0">
            Nenhum item cadastrado nesta seção.
          </p>
        </section>
      </ng-container>

      <!-- Aviso se não encontrou capa -->
      <div class="aviso-sem-capa no-print" *ngIf="!capa">
        <p>⚠️ Nenhuma capa encontrada para a regional "{{ bloco.regional }}"</p>
      </div>

    </div>

    <!-- PÁGINA: DETALHAMENTO DE DESVIOS COMPLEXOS -->
    <div class="a4-page desvios-page" *ngIf="bloco.desvios?.length > 0">
      <div class="doc-header">
        <div class="header-text">
          <h1>DETALHAMENTO DE DESVIOS COMPLEXOS</h1>
          <p class="subtitle">{{ bloco.nomeDoBloco }}</p>
        </div>
      </div>

      <section class="doc-section" *ngFor="let desvio of bloco.desvios; let i = index">
        <h3 class="section-title">DESVIO {{ i + 1 }} - {{ desvio.tipo | uppercase }}</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Tipo:</span>
            <span class="value">{{ desvio.tipo || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Linha:</span>
            <span class="value">{{ desvio.linha || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Data:</span>
            <span class="value">{{ desvio.data || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Hora:</span>
            <span class="value">{{ desvio.hora || '-' }}</span>
          </div>
          <div class="info-item full" *ngIf="desvio.sentidoHorario">
            <span class="label">Sentido Horário:</span>
            <span class="value">{{ desvio.sentidoHorario }}</span>
          </div>
          <div class="info-item full" *ngIf="desvio.trajetoSentHorario">
            <span class="label">Trajeto Sentido Horário:</span>
            <span class="value">{{ desvio.trajetoSentHorario }}</span>
          </div>
          <div class="info-item full" *ngIf="desvio.sentidoAntiHorario">
            <span class="label">Sentido Anti-Horário:</span>
            <span class="value">{{ desvio.sentidoAntiHorario }}</span>
          </div>
          <div class="info-item full" *ngIf="desvio.trajetoSentAntiHorario">
            <span class="label">Trajeto Sentido Anti-Horário:</span>
            <span class="value">{{ desvio.trajetoSentAntiHorario }}</span>
          </div>
        </div>
      </section>

      <div class="doc-footer">
        <p>Total de desvios: {{ bloco.desvios.length }}</p>
      </div>
    </div>
  </div>
</div>
