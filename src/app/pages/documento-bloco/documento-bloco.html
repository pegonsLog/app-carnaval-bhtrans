<div class="documento-container">
  <!-- Header com ações (não imprime) -->
  <div class="header-actions no-print">
    <button class="btn-voltar" (click)="voltar()">
      <ng-icon name="heroArrowLeft"></ng-icon>
      Voltar
    </button>
    <h1>Documento do Bloco</h1>
    <button class="btn-imprimir" (click)="imprimir()" [disabled]="isLoading">
      <ng-icon name="heroPrinter"></ng-icon>
      Imprimir
    </button>
  </div>

  <!-- Loading -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Carregando documento...</p>
  </div>

  <!-- Erro -->
  <div class="error-state" *ngIf="errorMessage && !isLoading">
    <p>{{ errorMessage }}</p>
    <button class="btn-voltar" (click)="voltar()">Voltar para lista</button>
  </div>

  <!-- Documento -->
  <div class="documento-wrapper" *ngIf="!isLoading && !errorMessage && bloco">

    <!-- PÁGINA 1: CAPA -->
    <div class="a4-page capa-page" *ngIf="capa">
      <div class="capa-header">
        <p class="linha">Empresa de Transportes e Trânsito de Belo Horizonte S/A - BHTRANS</p>
        <p class="linha">Diretoria de Ação Regional e Operação – DRO</p>
        <p class="linha">Superintendência de Ação Regional – SARE</p>
        <p class="linha">{{ capa.gerencia }}</p>
      </div>

      <div class="capa-centro">
        <h2 class="nome-bloco">{{ bloco.nomeDoBloco }}</h2>

        <div class="capa-logo">
          <img src="assets/logomarcas/logomarcas.png" alt="Logo" />
        </div>
      </div>

      <div class="capa-elaboracao">
        <p class="linha" *ngIf="capa.elaboradoPor">Elaboração: {{ capa.elaboradoPor }}</p>
      </div>

      <div class="capa-footer">
        <p class="cidade">BELO HORIZONTE</p>
        <p class="data">{{ capa.dataElaboracao ? formatarDataCapa(capa.dataElaboracao) : '' }}</p>
      </div>
    </div>

    <!-- PÁGINA: DADOS BELOTUR -->
    <div class="a4-page dados-page">
      <div class="doc-header">
        <div class="header-text">
          <h1>DADOS DO BLOCO</h1>
        </div>
      </div>

      <div class="doc-divider"></div>

      <!-- Identificação -->
      <section class="doc-section">
        <h3 class="section-title">IDENTIFICAÇÃO DO BLOCO</h3>
        <div class="info-grid">
          <div class="info-item full">
            <span class="label">Nome do Bloco:</span>
            <span class="value">{{ bloco.nomeDoBloco || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Nº Inscrição:</span>
            <span class="value">{{ bloco.numeroInscricao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Categoria:</span>
            <span class="value">{{ bloco.categoriaDoBloco || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Período:</span>
            <span class="value">{{ bloco.periodo || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Regional:</span>
            <span class="value">{{ bloco.regional || '-' }}</span>
          </div>
        </div>
      </section>

      <!-- Responsável -->
      <section class="doc-section">
        <h3 class="section-title">RESPONSÁVEL LEGAL</h3>
        <div class="info-grid">
          <div class="info-item full">
            <span class="label">Nome:</span>
            <span class="value">{{ bloco.responsavelLegal || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">CPF:</span>
            <span class="value">{{ bloco.cpf || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">CNPJ:</span>
            <span class="value">{{ bloco.cnpj || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">E-mail:</span>
            <span class="value">{{ bloco.email || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Celular:</span>
            <span class="value">{{ bloco.celular || '-' }}</span>
          </div>
        </div>
      </section>



      <!-- Data e Horários -->
      <section class="doc-section">
        <h3 class="section-title">DATA E HORÁRIOS DO DESFILE</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Data do Desfile:</span>
            <span class="value">{{ formatDate(bloco.dataDoDesfile) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Concentração:</span>
            <span class="value">{{ bloco.horarioDeconcentracao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Início:</span>
            <span class="value">{{ bloco.inicioDoDesfile || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Encerramento:</span>
            <span class="value">{{ bloco.horarioEncerramento || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Duração:</span>
            <span class="value">{{ bloco.duracaoDoDesfile || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Dispersão:</span>
            <span class="value">{{ bloco.horarioDispersao || '-' }}</span>
          </div>
        </div>
      </section>

      <!-- Público -->
      <section class="doc-section">
        <h3 class="section-title">PÚBLICO ESTIMADO</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Público Anterior:</span>
            <span class="value">{{ formatNumber(bloco.publicoAnterior) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Público Declarado:</span>
            <span class="value">{{ formatNumber(bloco.publicoDeclarado) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Área do Trajeto:</span>
            <span class="value">{{ formatNumber(bloco.areaDoTrajetoM2) }} m²</span>
          </div>
          <div class="info-item">
            <span class="label">Capacidade:</span>
            <span class="value">{{ formatNumber(bloco.capacidadePublicoDoTrajeto) }} pessoas</span>
          </div>
        </div>
      </section>

      <!-- Percurso -->
      <section class="doc-section">
        <h3 class="section-title">PERCURSO E LOCALIZAÇÃO</h3>
        <div class="info-grid">
          <div class="info-item full">
            <span class="label">Percurso:</span>
            <span class="value">{{ bloco.percurso || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">End. Concentração:</span>
            <span class="value">{{ bloco.enderecoDeConcentracao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Bairro Concentração:</span>
            <span class="value">{{ bloco.bairroDeConcentracao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">End. Dispersão:</span>
            <span class="value">{{ bloco.enderecoDeDispersao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Bairro Dispersão:</span>
            <span class="value">{{ bloco.bairroDeDispersao || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Extensão:</span>
            <span class="value">{{ formatNumber(bloco.extensaoDoDesfileMetros) }} m</span>
          </div>
          <div class="info-item">
            <span class="label">Nº de Quadras:</span>
            <span class="value">{{ bloco.numeroDeQuadras || '-' }}</span>
          </div>
        </div>
      </section>

      <!-- Características -->
      <section class="doc-section">
        <h3 class="section-title">CARACTERÍSTICAS</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Perfil:</span>
            <span class="value">{{ bloco.perfil || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Estilo Musical:</span>
            <span class="value">{{ bloco.estiloDeMusica || '-' }}</span>
          </div>
          <div class="info-item full">
            <span class="label">Descrição:</span>
            <span class="value">{{ bloco.descricaoDoBloco || '-' }}</span>
          </div>
        </div>
      </section>


      <!-- Status -->
      <section class="doc-section">
        <h3 class="section-title">STATUS</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Possui Desfiles:</span>
            <span class="value">{{ formatBoolean(bloco.possuiDesfiles) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Status do Desfile:</span>
            <span class="value">{{ bloco.statusDoDesfile || '-' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Autoriza Divulgação:</span>
            <span class="value">{{ formatBoolean(bloco.autorizaDivulgacao) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Primeiro Cadastro:</span>
            <span class="value">{{ formatBoolean(bloco.primeiroCadastro) }}</span>
          </div>
        </div>
      </section>


      <!-- Equipamentos -->
      <section class="doc-section">
        <h3 class="section-title">EQUIPAMENTOS E DIMENSÕES</h3>
        <div class="info-grid">
          <div class="info-item full">
            <span class="label">Equipamentos:</span>
            <span class="value">{{ formatArray(bloco.equipamentosUtilizados) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Largura:</span>
            <span class="value">{{ bloco.larguraMetros || '-' }} m</span>
          </div>
          <div class="info-item">
            <span class="label">Comprimento:</span>
            <span class="value">{{ bloco.comprimentoMetros || '-' }} m</span>
          </div>
          <div class="info-item">
            <span class="label">Altura:</span>
            <span class="value">{{ bloco.alturaMetros || '-' }} m</span>
          </div>
          <div class="info-item">
            <span class="label">Potência:</span>
            <span class="value">{{ formatNumber(bloco.potenciaWatts) }} W</span>
          </div>
        </div>
      </section>

      <div class="doc-footer">
        <p>Data de Cadastro/Modificação: {{ formatDate(bloco.dataCadastroModificacao) }}</p>
      </div>
    </div>

    <!-- PÁGINA: MAPA (iframe do Google Maps) -->
    <div class="a4-page mapa-page" *ngIf="safeMapUrl || parsedMymaps?.mapUrl">
      <div class="doc-header">
        <div class="header-text">
          <h1>MAPA DO BLOCO</h1>
        </div>
      </div>

      <div class="doc-divider"></div>

      <div class="mapa-container" *ngIf="safeMapUrl">
        <iframe [src]="safeMapUrl" width="100%" height="100%" frameborder="0" allowfullscreen>
        </iframe>
      </div>

      <!-- Fallback: link para abrir o mapa -->
      <div class="mapa-fallback" *ngIf="!safeMapUrl && parsedMymaps?.mapUrl">
        <p>O mapa não pode ser exibido diretamente.</p>
        <a [href]="parsedMymaps.mapUrl" target="_blank" rel="noopener" class="btn-abrir-mapa">
          Abrir Mapa no Google Maps
        </a>
      </div>

      <div class="doc-footer">
        <p>Mapa gerado a partir do Google My Maps</p>
        <p class="map-url no-print" *ngIf="mapEmbedUrl">URL: {{ mapEmbedUrl }}</p>
      </div>
    </div>

    <!-- PÁGINA: DADOS OPERACIONAIS (quebra automática) -->
    <div class="a4-page dados-operacionais-page"
      *ngIf="bloco.fechamentos?.length > 0 || bloco.sinalizacoes?.length > 0 || bloco.desvios?.length > 0 || bloco.agentes?.length > 0 || bloco.reservasArea?.length > 0 || bloco.faixasTecido?.length > 0">
      <div class="doc-header">
        <div class="header-text">
          <h1>DADOS OPERACIONAIS</h1>
          <p class="subtitle">{{ bloco.nomeDoBloco }}</p>
        </div>
      </div>
      <div class="doc-divider"></div>

      <!-- FECHAMENTOS -->
      <section class="secao-operacional" *ngIf="bloco.fechamentos?.length > 0">
        <h3 class="section-title">FECHAMENTOS</h3>
        <div class="tabela-operacional">
          <table>
            <thead>
              <tr>
                <th>Endereço</th>
                <th>Sinalização</th>
                <th>Qtd</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of bloco.fechamentos">
                <td>{{ item.endereco }}</td>
                <td>{{ item.sinalizacao || '-' }}</td>
                <td class="center">{{ item.quantidade }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="total-secao">Total: {{ bloco.fechamentos.length }} fechamento(s)</p>
      </section>

      <!-- SINALIZAÇÃO -->
      <section class="secao-operacional" *ngIf="bloco.sinalizacoes?.length > 0">
        <h3 class="section-title">SINALIZAÇÃO</h3>
        <div class="tabela-operacional">
          <table>
            <thead>
              <tr>
                <th>Código da Placa</th>
                <th>Local</th>
                <th>Qtd</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of bloco.sinalizacoes">
                <td>{{ item.codigoPlaca }}</td>
                <td>{{ item.local }}</td>
                <td class="center">{{ item.quantidade }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="total-secao">Total: {{ getTotalSinalizacoes() }} sinalização(ões)</p>
      </section>

      <!-- DESVIOS -->
      <section class="secao-operacional" *ngIf="bloco.desvios?.length > 0">
        <h3 class="section-title">DESVIOS</h3>
        <div class="tabela-operacional">
          <table>
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Linha</th>
                <th>Hora</th>
                <th>Sentido Horário</th>
                <th>Trajeto Sent. Horário</th>
                <th>Sentido Anti-Horário</th>
                <th>Trajeto Sent. Anti-Horário</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of bloco.desvios">
                <td>{{ item.tipo }}</td>
                <td>{{ item.linha }}</td>
                <td>{{ item.hora || '-' }}</td>
                <td>{{ item.sentidoHorario || '-' }}</td>
                <td>{{ item.trajetoSentHorario || '-' }}</td>
                <td>{{ item.sentidoAntiHorario || '-' }}</td>
                <td>{{ item.trajetoSentAntiHorario || '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="total-secao">Total: {{ bloco.desvios.length }} desvio(s)</p>
      </section>

      <!-- AGENTES -->
      <section class="secao-operacional" *ngIf="bloco.agentes?.length > 0">
        <h3 class="section-title">AGENTES</h3>
        <div class="tabela-operacional">
          <table>
            <thead>
              <tr>
                <th>Local</th>
                <th>Órgão</th>
                <th>Atividade</th>
                <th>Qtd</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of bloco.agentes">
                <td>{{ item.local }}</td>
                <td>{{ item.orgao }}</td>
                <td>{{ item.atividade || '-' }}</td>
                <td class="center">{{ item.quantidade }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="total-secao">Total: {{ getTotalAgentes() }} agente(s)</p>
      </section>

      <!-- RESERVA DE ÁREA -->
      <section class="secao-operacional" *ngIf="bloco.reservasArea?.length > 0">
        <h3 class="section-title">RESERVA DE ÁREA</h3>
        <div class="tabela-operacional">
          <table>
            <thead>
              <tr>
                <th>Endereço</th>
                <th>Sentido</th>
                <th>Sinalização</th>
                <th>Qtd</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of bloco.reservasArea">
                <td>{{ item.endereco }}</td>
                <td>{{ item.sentido || '-' }}</td>
                <td>{{ item.sinalizacao || '-' }}</td>
                <td class="center">{{ item.quantidade }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="total-secao">Total: {{ bloco.reservasArea.length }} reserva(s)</p>
      </section>

      <!-- FAIXAS DE TECIDO -->
      <section class="secao-operacional" *ngIf="bloco.faixasTecido?.length > 0">
        <h3 class="section-title">FAIXAS DE TECIDO</h3>
        <div class="tabela-operacional">
          <table>
            <thead>
              <tr>
                <th>Faixa</th>
                <th>Local</th>
                <th>Sentido</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of bloco.faixasTecido">
                <td>{{ item.faixa }}</td>
                <td>{{ item.local }}</td>
                <td>{{ item.sentido || '-' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="total-secao">Total: {{ bloco.faixasTecido.length }} faixa(s)</p>
      </section>
    </div>

    <!-- Aviso se não encontrou capa -->
    <div class="aviso-sem-capa no-print" *ngIf="!capa">
      <p>⚠️ Nenhuma capa encontrada para a regional "{{ bloco.regional }}"</p>
    </div>

  </div>
</div>
